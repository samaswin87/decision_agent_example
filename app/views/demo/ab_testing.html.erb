<div class="card">
  <h2>üß™ A/B Testing - Rule Version Comparison</h2>
  <p>Compare different rule versions and analyze which performs better using statistical significance.</p>
</div>

<!-- Test Creation Section -->
<div class="card">
  <h3>üìù Create New A/B Test</h3>
  <form id="createTestForm">
    <div class="form-group">
      <label>Test Name:</label>
      <input type="text" id="testName" class="form-control" placeholder="Transaction Approval Threshold Test" required>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Champion Version ID:</label>
        <input type="text" id="championVersionId" class="form-control" placeholder="v1_conservative" required>
      </div>

      <div class="form-group">
        <label>Challenger Version ID:</label>
        <input type="text" id="challengerVersionId" class="form-control" placeholder="v2_aggressive" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Champion Traffic %:</label>
        <input type="number" id="championTraffic" class="form-control" value="90" min="0" max="100" required>
      </div>

      <div class="form-group">
        <label>Challenger Traffic %:</label>
        <input type="number" id="challengerTraffic" class="form-control" value="10" min="0" max="100" required>
      </div>
    </div>

    <button type="submit" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      Create A/B Test
    </button>
  </form>
</div>

<!-- Active Tests Section -->
<div class="card">
  <h3>üìä Active A/B Tests</h3>
  <div id="activeTestsList">
    <p class="loading-text">Loading active tests...</p>
  </div>
</div>

<!-- Test Execution Section -->
<div class="card">
  <h3>üéØ Run A/B Test</h3>
  <form id="runTestForm">
    <div class="form-group">
      <label>Select Test:</label>
      <select id="testSelect" class="form-control" required>
        <option value="">-- Select a test --</option>
      </select>
    </div>

    <div class="form-group">
      <label>Number of Users to Test:</label>
      <input type="number" id="userCount" class="form-control" value="100" min="10" max="10000">
    </div>

    <div class="form-group">
      <label>Test Scenario:</label>
      <select id="scenario" class="form-control">
        <option value="low_amounts">Low Amounts ($100-$500)</option>
        <option value="medium_amounts">Medium Amounts ($500-$2000)</option>
        <option value="high_amounts">High Amounts ($2000-$10000)</option>
        <option value="mixed">Mixed Amounts</option>
      </select>
    </div>

    <button type="submit" class="btn" style="background: #27ae60;">
      Run A/B Test
    </button>
  </form>

  <div id="testProgress" style="display: none; margin-top: 20px;">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <p id="progressText" style="text-align: center; margin-top: 10px;"></p>
  </div>
</div>

<!-- Results Section -->
<div class="card" id="resultsCard" style="display: none;">
  <h3>üìà Test Results</h3>
  <div id="testResults"></div>
</div>

<style>
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #2c3e50;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
}

.progress-bar {
  width: 100%;
  height: 30px;
  background: #ecf0f1;
  border-radius: 15px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  width: 0%;
  transition: width 0.3s ease;
}

.test-card {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 15px;
  border-left: 4px solid #667eea;
}

.variant-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 20px;
}

.variant-box {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
}

.champion-box {
  border-color: #f39c12;
  background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

.challenger-box {
  border-color: #667eea;
  background: linear-gradient(135deg, #e6e9ff 0%, #ffffff 100%);
}

.metric {
  margin-bottom: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #ecf0f1;
}

.metric:last-child {
  border-bottom: none;
}

.metric-label {
  font-weight: 600;
  color: #7f8c8d;
  font-size: 13px;
  text-transform: uppercase;
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #2c3e50;
  margin-top: 5px;
}

.comparison-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 12px;
  margin-top: 20px;
  text-align: center;
}

.winner-badge {
  display: inline-block;
  background: #27ae60;
  color: white;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: bold;
  margin-left: 10px;
}

.loading-text {
  text-align: center;
  color: #7f8c8d;
  font-style: italic;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadActiveTests();

  document.getElementById('createTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    createABTest();
  });

  document.getElementById('runTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    runABTest();
  });
});

function loadActiveTests() {
  // Simulate loading active tests
  setTimeout(() => {
    const activeTestsList = document.getElementById('activeTestsList');
    const testSelect = document.getElementById('testSelect');

    const mockTests = [
      {
        id: 'test_001',
        name: 'Transaction Approval Threshold Test',
        championVersion: 'v1_conservative',
        challengerVersion: 'v2_aggressive',
        trafficSplit: { champion: 90, challenger: 10 },
        status: 'active',
        totalAssignments: 1523
      },
      {
        id: 'test_002',
        name: 'Fraud Detection Sensitivity Test',
        championVersion: 'v3_balanced',
        challengerVersion: 'v4_sensitive',
        trafficSplit: { champion: 80, challenger: 20 },
        status: 'active',
        totalAssignments: 892
      }
    ];

    if (mockTests.length === 0) {
      activeTestsList.innerHTML = '<p class="loading-text">No active tests. Create one above!</p>';
    } else {
      activeTestsList.innerHTML = mockTests.map(test => `
        <div class="test-card">
          <h4>${test.name}</h4>
          <p><strong>Test ID:</strong> ${test.id}</p>
          <p><strong>Champion:</strong> ${test.championVersion} (${test.trafficSplit.champion}%) |
             <strong>Challenger:</strong> ${test.challengerVersion} (${test.trafficSplit.challenger}%)</p>
          <p><strong>Status:</strong> <span style="color: #27ae60; font-weight: bold;">${test.status}</span> |
             <strong>Total Assignments:</strong> ${test.totalAssignments}</p>
          <button onclick="viewTestResults('${test.id}')" class="btn" style="background: #3498db; margin-top: 10px;">
            View Results
          </button>
          <button onclick="completeTest('${test.id}')" class="btn" style="background: #95a5a6; margin-top: 10px;">
            Complete Test
          </button>
        </div>
      `).join('');

      // Populate test select
      testSelect.innerHTML = '<option value="">-- Select a test --</option>' +
        mockTests.map(test => `<option value="${test.id}">${test.name}</option>`).join('');
    }
  }, 500);
}

function createABTest() {
  const testName = document.getElementById('testName').value;
  const championVersionId = document.getElementById('championVersionId').value;
  const challengerVersionId = document.getElementById('challengerVersionId').value;
  const championTraffic = parseInt(document.getElementById('championTraffic').value);
  const challengerTraffic = parseInt(document.getElementById('challengerTraffic').value);

  if (championTraffic + challengerTraffic !== 100) {
    alert('Traffic splits must add up to 100%');
    return;
  }

  // Simulate API call
  console.log('Creating A/B test:', {
    name: testName,
    championVersionId,
    challengerVersionId,
    trafficSplit: { champion: championTraffic, challenger: challengerTraffic }
  });

  alert(`A/B Test "${testName}" created successfully!`);
  loadActiveTests();
  document.getElementById('createTestForm').reset();
}

function runABTest() {
  const testId = document.getElementById('testSelect').value;
  const userCount = parseInt(document.getElementById('userCount').value);
  const scenario = document.getElementById('scenario').value;

  if (!testId) {
    alert('Please select a test');
    return;
  }

  const progressDiv = document.getElementById('testProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');

  progressDiv.style.display = 'block';
  progressFill.style.width = '0%';

  // Simulate test execution
  let processed = 0;
  const interval = setInterval(() => {
    processed += Math.floor(Math.random() * 10) + 5;
    if (processed >= userCount) {
      processed = userCount;
      clearInterval(interval);

      setTimeout(() => {
        progressDiv.style.display = 'none';
        showTestResults(testId, userCount, scenario);
      }, 500);
    }

    const percentage = (processed / userCount * 100);
    progressFill.style.width = percentage + '%';
    progressText.textContent = `Processing: ${processed} / ${userCount} users (${percentage.toFixed(1)}%)`;
  }, 100);
}

function showTestResults(testId, userCount, scenario) {
  const resultsCard = document.getElementById('resultsCard');
  const testResults = document.getElementById('testResults');

  // Generate mock results
  const championApprovals = Math.floor(userCount * 0.9 * 0.45);
  const championReviews = Math.floor(userCount * 0.9) - championApprovals;
  const challengerApprovals = Math.floor(userCount * 0.1 * 0.68);
  const challengerReviews = Math.floor(userCount * 0.1) - challengerApprovals;

  const championConfidence = 0.82;
  const challengerConfidence = 0.79;

  testResults.innerHTML = `
    <div class="variant-stats">
      <div class="variant-box champion-box">
        <h4>üèÜ CHAMPION</h4>
        <div class="metric">
          <div class="metric-label">Assignments</div>
          <div class="metric-value">${Math.floor(userCount * 0.9)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Approvals</div>
          <div class="metric-value">${championApprovals}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Reviews</div>
          <div class="metric-value">${championReviews}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Avg Confidence</div>
          <div class="metric-value">${championConfidence.toFixed(3)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Approval Rate</div>
          <div class="metric-value">${(championApprovals / (userCount * 0.9) * 100).toFixed(1)}%</div>
        </div>
      </div>

      <div class="variant-box challenger-box">
        <h4>üÜï CHALLENGER</h4>
        <div class="metric">
          <div class="metric-label">Assignments</div>
          <div class="metric-value">${Math.floor(userCount * 0.1)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Approvals</div>
          <div class="metric-value">${challengerApprovals}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Reviews</div>
          <div class="metric-value">${challengerReviews}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Avg Confidence</div>
          <div class="metric-value">${challengerConfidence.toFixed(3)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Approval Rate</div>
          <div class="metric-value">${(challengerApprovals / (userCount * 0.1) * 100).toFixed(1)}%</div>
        </div>
      </div>
    </div>

    <div class="comparison-box">
      <h3 style="margin-bottom: 20px;">üìä Statistical Analysis</h3>
      <p style="font-size: 18px; margin-bottom: 15px;">
        Challenger shows <strong>+${((challengerApprovals / (userCount * 0.1)) / (championApprovals / (userCount * 0.9)) * 100 - 100).toFixed(1)}%</strong> improvement in approval rate
      </p>
      <p style="font-size: 16px; opacity: 0.9;">
        Statistical Significance: <strong>${userCount >= 100 ? 'Significant' : 'Insufficient Data'}</strong><br>
        Confidence Level: <strong>${userCount >= 100 ? '95%' : 'N/A'}</strong>
      </p>
      <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 8px;">
        <h4 style="margin-bottom: 10px;">üí° Recommendation:</h4>
        <p style="font-size: 16px; margin: 0;">
          ${challengerApprovals / (userCount * 0.1) > championApprovals / (userCount * 0.9) ?
            'Consider promoting the challenger version to production. Monitor for any unintended side effects.' :
            'Keep the champion version. The challenger does not show significant improvement.'}
        </p>
      </div>
    </div>
  `;

  resultsCard.style.display = 'block';
  resultsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function viewTestResults(testId) {
  showTestResults(testId, 1523, 'mixed');
}

function completeTest(testId) {
  if (confirm('Are you sure you want to complete this test? This action cannot be undone.')) {
    alert(`Test ${testId} has been marked as completed.`);
    loadActiveTests();
  }
}
</script>
