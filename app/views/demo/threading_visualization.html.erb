<div class="container my-5">
  <h1 class="mb-4">üßµ Threading Visualization & Real-Time Monitoring</h1>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Configure Threading Test</h5>
        </div>
        <div class="card-body">
          <form id="threadingTestForm">
            <div class="row">
              <div class="col-md-4">
                <label class="form-label">Use Case</label>
                <select class="form-control" id="useCase" name="use_case">
                  <option value="simple_loan">Simple Loan Approval</option>
                  <option value="fraud_detection">Fraud Detection</option>
                  <option value="discount_engine">Discount Engine</option>
                  <option value="insurance_underwriting">Insurance Underwriting</option>
                  <option value="content_moderation">Content Moderation</option>
                  <option value="dynamic_pricing">Dynamic Pricing</option>
                  <option value="recommendation_engine">Recommendation Engine</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Thread Count</label>
                <input type="number" class="form-control" id="threadCount" name="thread_count" value="4" min="1" max="32">
                <small class="text-muted">Recommended: 2-8 threads</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">Operations per Thread</label>
                <input type="number" class="form-control" id="operationsPerThread" name="operations_per_thread" value="100" min="10" max="10000">
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-success btn-lg" id="runTestBtn">
                üöÄ Run Threading Test
              </button>
              <span id="loadingSpinner" class="ms-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                Running test...
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" style="display: none;">
    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Total Operations</h6>
            <h2 class="card-title" id="totalOperations">-</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Duration</h6>
            <h2 class="card-title" id="totalDuration">-</h2>
            <small class="text-muted">seconds</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Throughput</h6>
            <h2 class="card-title text-success" id="throughput">-</h2>
            <small class="text-muted">ops/sec</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Errors</h6>
            <h2 class="card-title text-danger" id="totalErrors">-</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Thread Performance Visualization -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Thread Performance Breakdown</h5>
          </div>
          <div class="card-body">
            <div id="threadBars"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Latency Statistics -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Latency Distribution</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <tbody>
                <tr>
                  <th>Minimum</th>
                  <td id="latencyMin">-</td>
                </tr>
                <tr>
                  <th>Maximum</th>
                  <td id="latencyMax">-</td>
                </tr>
                <tr>
                  <th>Average</th>
                  <td id="latencyAvg">-</td>
                </tr>
                <tr>
                  <th>P50 (Median)</th>
                  <td id="latencyP50">-</td>
                </tr>
                <tr>
                  <th>P95</th>
                  <td id="latencyP95">-</td>
                </tr>
                <tr>
                  <th>P99</th>
                  <td id="latencyP99">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Thread Details -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Thread Details</h5>
          </div>
          <div class="card-body">
            <div id="threadDetails" style="max-height: 300px; overflow-y: auto;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Raw JSON Data -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Raw Test Results (JSON)</h5>
          </div>
          <div class="card-body">
            <pre id="rawJson" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 5px;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('threadingTestForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const params = new URLSearchParams(formData);

  // Show loading
  document.getElementById('runTestBtn').disabled = true;
  document.getElementById('loadingSpinner').style.display = 'inline-block';
  document.getElementById('resultsSection').style.display = 'none';

  try {
    const response = await fetch('/demo/run_threading_test', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: params
    });

    const data = await response.json();
    displayResults(data);
  } catch (error) {
    alert('Error running test: ' + error.message);
  } finally {
    document.getElementById('runTestBtn').disabled = false;
    document.getElementById('loadingSpinner').style.display = 'none';
  }
});

function displayResults(data) {
  // Show results section
  document.getElementById('resultsSection').style.display = 'block';

  // Update summary cards
  document.getElementById('totalOperations').textContent = data.operations_completed.toLocaleString();
  document.getElementById('totalDuration').textContent = data.total_duration.toFixed(3);
  document.getElementById('throughput').textContent = data.throughput.toFixed(2);
  document.getElementById('totalErrors').textContent = data.errors.toLocaleString();

  // Update latency stats
  document.getElementById('latencyMin').textContent = data.latency_stats.min + ' ms';
  document.getElementById('latencyMax').textContent = data.latency_stats.max + ' ms';
  document.getElementById('latencyAvg').textContent = data.latency_stats.avg + ' ms';
  document.getElementById('latencyP50').textContent = data.latency_stats.p50 + ' ms';
  document.getElementById('latencyP95').textContent = data.latency_stats.p95 + ' ms';
  document.getElementById('latencyP99').textContent = data.latency_stats.p99 + ' ms';

  // Render thread bars
  renderThreadBars(data.thread_results);

  // Render thread details
  renderThreadDetails(data.thread_results);

  // Show raw JSON
  document.getElementById('rawJson').textContent = JSON.stringify(data, null, 2);

  // Scroll to results
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function renderThreadBars(threadResults) {
  const container = document.getElementById('threadBars');
  const maxOps = Math.max(...threadResults.map(t => t.operations));

  let html = '';
  threadResults.forEach(thread => {
    const percentage = (thread.operations / maxOps) * 100;
    const barColor = thread.errors > 0 ? 'bg-warning' : 'bg-success';

    html += `
      <div class="mb-3">
        <div class="d-flex justify-content-between mb-1">
          <span><strong>Thread ${thread.thread_id + 1}</strong></span>
          <span>${thread.operations} ops in ${thread.duration}s (${thread.avg_latency}ms avg)</span>
        </div>
        <div class="progress" style="height: 30px;">
          <div class="progress-bar ${barColor}" role="progressbar"
               style="width: ${percentage}%"
               aria-valuenow="${percentage}"
               aria-valuemin="0"
               aria-valuemax="100">
            ${thread.operations} ops
          </div>
        </div>
        ${thread.errors > 0 ? `<small class="text-danger">‚ö†Ô∏è ${thread.errors} errors</small>` : ''}
      </div>
    `;
  });

  container.innerHTML = html;
}

function renderThreadDetails(threadResults) {
  const container = document.getElementById('threadDetails');

  let html = '<table class="table table-sm table-striped">';
  html += '<thead><tr><th>Thread</th><th>Operations</th><th>Errors</th><th>Avg Latency</th><th>Duration</th></tr></thead>';
  html += '<tbody>';

  threadResults.forEach(thread => {
    html += `
      <tr>
        <td>Thread ${thread.thread_id + 1}</td>
        <td>${thread.operations}</td>
        <td class="${thread.errors > 0 ? 'text-danger' : ''}">${thread.errors}</td>
        <td>${thread.avg_latency} ms</td>
        <td>${thread.duration}s</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}
</script>

<style>
.card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.progress {
  border-radius: 5px;
}

.progress-bar {
  transition: width 0.6s ease;
}
</style>
